#!/usr/bin/env ruby

require_relative '../lib/karafka'
require 'optparse'

# If there is a boot file, we need to require it as we expect it to contain
# Karafka app setup, routes, etc
if File.exist?(Karafka.boot_file)
  require Karafka.boot_file.to_s
else
  # However when it is unavailable, we still want to be able to run help command
  # and install command as they don't require configured app itself to run
  raise(
    Karafka::Errors::MissingBootFileError,
    Karafka.boot_file
  ) unless %w[-h install].include?(ARGV[0])
end

# Command we want to run, like install, server, etc
command_name = ARGV[0]
# Action for action-based commands like topics migrate
action = ARGV[1] unless ARGV[1].to_s.start_with?('-')

Karafka::Cli::Base.load

ObjectSpace
  .each_object(Class).select { |klass| klass < Karafka::Cli::Base }
  .each do |command|
    next unless command.names.include?(command_name)

    # Only actionable commands require command as an argument
    args = action ? [action] : []

    return command.new.call(*args)
  end

raise
